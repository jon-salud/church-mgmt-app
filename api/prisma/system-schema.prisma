// System metadata database for multi-tenant management
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("SYSTEM_DATABASE_URL")
}

model Tenant {
  id            String   @id @default(cuid())
  name          String
  subdomain     String   @unique
  databaseName  String   @unique
  databaseUrl   String   // Encrypted connection string
  status        String   @default("active") // active, suspended, deleted
  plan          String   @default("free") // free, basic, premium
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  settings      TenantSettings?
  usage         TenantUsage?

  @@map("tenants")
}

model TenantSettings {
  tenantId      String  @id
  logoUrl       String?
  brandColor    String?
  timezone      String  @default("UTC")
  features      Json?   // Feature flags and limits
  tenant        Tenant  @relation(fields: [tenantId], references: [id])

  @@map("tenant_settings")
}

model TenantUsage {
  tenantId          String   @id
  databaseSizeMb    Float    @default(0)
  monthlyQueries    Int      @default(0)
  activeUsers       Int      @default(0)
  storageUsedMb     Float    @default(0)
  lastCalculatedAt  DateTime @default(now())
  tenant            Tenant   @relation(fields: [tenantId], references: [id])

  @@map("tenant_usage")
}

model SystemUser {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String?
  role          String   @default("admin") // admin, support
  status        String   @default("active")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("system_users")
}

model SystemAuditLog {
  id          String   @id @default(cuid())
  actorId     String?
  action      String
  entity      String
  entityId    String
  details     Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@map("system_audit_logs")
}